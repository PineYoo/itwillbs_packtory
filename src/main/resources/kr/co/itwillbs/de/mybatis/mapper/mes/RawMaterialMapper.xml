<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.itwillbs.de.mes.mapper.RawMaterialMapper">

	<!-- 원자재 등록 -->
	<insert id="insertRawMaterial" useGeneratedKeys="true" keyProperty="idx" parameterType="kr.co.itwillbs.de.mes.dto.RawMaterialDTO">
		INSERT INTO t_raw_material (
		<trim suffixOverrides=",">
			<if test='bomIdx != null and !("".equals(bomIdx.trim()))'>
				bom_idx,
			</if>
			<if test='clientIdx != null and !("".equals(clientIdx.trim()))'>
				client_idx,
			</if>
			<if test='type != null and !("".equals(type.trim()))'>
				type,
			</if>
			<if test='name != null and !("".equals(name.trim()))'>
				name,
			</if>
			<if test='quantity != null'>
				quantity,
			</if>
			<if test='unit != null and !("".equals(unit.trim()))'>
				unit,
			</if>
			<if test='price != null'>
				price,
			</if>
			<if test='expirationDate != null'>
				expiration_date,
			</if>
			<if test='isDeleted !=null and !("".equals(isDeleted.trim()))'>
				is_deleted,
			</if>
			reg_id,
			reg_date,
		</trim>
		) VALUES (
		<trim suffixOverrides=",">
			<if test='bomIdx != null and !("".equals(bomIdx.trim()))'>
				#{bomIdx},
			</if>
			<if test='clientIdx != null and !("".equals(clientIdx.trim()))'>
				#{clientIdx},
			</if>
			<if test='type != null and !("".equals(type.trim()))'>
				#{type},
			</if>
			<if test='name != null and !("".equals(name.trim()))'>
				#{name},
			</if>
			<if test='quantity != null'>
				#{quantity},
			</if>
			<if test='unit != null and !("".equals(unit.trim()))'>
				#{unit},
			</if>
			<if test='price != null'>
				#{price},
			</if>
			<if test='expirationDate != null'>
				#{expirationDate},
			</if>
			<if test='isDeleted !=null and !("".equals(isDeleted.trim()))'>
				#{isDeleted},
			</if>
			#{regId},
			now(),
		</trim>
		)
	</insert>

	<!-- 목록 조회 + 페이징 -->
	<select id="searchRawMaterialCount" parameterType="kr.co.itwillbs.de.mes.dto.RawMaterialSearchDTO" resultType="int">
		SELECT COUNT(*)
		FROM t_raw_material
		<where>
			<if test="type != null and !(''.equals(type.trim()))">
				AND type = #{type}
			</if>
			<if test="name != null and !(''.equals(name.trim()))">
				AND name LIKE CONCAT('%', #{name}, '%')
			</if>

			<if test="clientIdx != null and !(''.equals(clientIdx.trim()))">
				AND client_idx = #{clientIdx}
			</if>

			<if test="bomIdx != null and !(''.equals(bomIdx.trim()))">
				AND bom_idx = #{bomIdx}
			</if>

			<if test="minQuantity != null">
				AND quantity &gt;= #{minQuantity}
			</if>

			<if test="maxQuantity != null">
				AND quantity &lt;= #{maxQuantity}
			</if>

			<if test="minPrice != null">
				AND price &gt;= #{minPrice}
			</if>

			<if test="maxPrice != null">
				AND price &lt;= #{maxPrice}
			</if>
		</where>
	</select>

	<!-- 원자재 목록 조회 -->
	<select id="searchRawMaterial" parameterType="kr.co.itwillbs.de.mes.dto.RawMaterialSearchDTO" resultType="kr.co.itwillbs.de.mes.dto.RawMaterialDTO">

		SELECT
		r.*,
		c.company_name AS clientCompanyName,
		b.name AS bomName
		FROM
		t_raw_material r
		LEFT JOIN t_client c ON r.client_idx = c.idx
		LEFT JOIN
		t_bom b ON r.bom_idx = b.idx
		<where>
			<if test="type != null and !(''.equals(type.trim()))">
				AND type = #{type}
			</if>
			<if test="name != null and !(''.equals(name.trim()))">
				AND name LIKE CONCAT('%', #{name}, '%')
			</if>

			<if test="clientIdx != null and !(''.equals(clientIdx.trim()))">
				AND client_idx = #{clientIdx}
			</if>

			<if test="bomIdx != null and !(''.equals(bomIdx.trim()))">
				AND bom_idx = #{bomIdx}
			</if>

			<if test="minQuantity != null">
				AND quantity &gt;= #{minQuantity}
			</if>

			<if test="maxQuantity != null">
				AND quantity &lt;= #{maxQuantity}
			</if>

			<if test="minPrice != null">
				AND price &gt;= #{minPrice}
			</if>

			<if test="maxPrice != null">
				AND price &lt;= #{maxPrice}
			</if>
		</where>

		ORDER BY r.idx ASC
		LIMIT #{pageDTO.size} OFFSET #{pageDTO.offset}
	</select>

	<!-- 원자재 상세 조회 -->
	<select id="getRawMaterialByIdx" parameterType="Long" resultType="kr.co.itwillbs.de.mes.dto.RawMaterialDTO">
		SELECT
		r.*,
		c.company_name AS clientcompanyname,
		b.name AS
		bomname
		FROM
		t_raw_material r
		LEFT JOIN t_client c ON r.client_idx =
		c.idx
		LEFT JOIN t_bom b ON r.bom_idx = b.idx
		WHERE r.idx = #{idx}
	</select>

	<!-- 원자재 정보 수정 -->
	<update id="updateRawMaterial" parameterType="kr.co.itwillbs.de.mes.dto.RawMaterialDTO">
		UPDATE t_raw_material
		<set>
			<if test='type != null and !("".equals(type.trim()))'>type = #{type},</if>
			<if test='bomIdx != null and !("".equals(bomIdx.trim()))'>bom_idx = #{bomIdx},</if>
			<if test='clientIdx != null and !("".equals(clientIdx.trim()))'>client_idx = #{clientIdx},</if>
			<if test='name != null and !("".equals(name.trim()))'>name = #{name},</if>
			<if test='quantity != null'>quantity = #{quantity},</if>
			<if test='unit != null and !("".equals(unit.trim()))'>unit = #{unit},</if>
			<if test='expirationDate != null and !("".equals(expirationDate.trim()))'>expiration_date = #{expirationDate},</if>
			<if test='isDeleted != null and !("".equals(isDeleted.trim()))'>is_deleted = #{isDeleted},</if>
			<if test='modId != null and !("".equals(modId.trim()))'>mod_id = #{modId},</if>
			<if test='modId !=null and !("".equals(modId.trim()))'>mod_date = now(),</if>
		</set>
		WHERE idx = #{idx}
	</update>

	<!-- 원자재 정보 들고가기 (외부용) -->
	<select id="selectRawMaterialList" parameterType="Long" resultType="kr.co.itwillbs.de.mes.dto.RawMaterialDTO">
		SELECT idx, name
		FROM t_raw_material
		WHERE is_deleted = 'N'
	</select>

</mapper>
