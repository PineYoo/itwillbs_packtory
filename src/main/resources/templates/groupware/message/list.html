<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{common/layouts/de_layout}">
<head>
<title>팩토리(PackTory) - 메시지 목록</title>

<style>
.left-form {
	border-right: 1px solid #e3e6f0;
}

@media ( max-width : 768px) {
	.left-form {
		border-right: none !important;
	}
}

.table th, .table td {
	vertical-align: middle;
}
</style>
</head>
<body id="page-top">
	<th:block layout:fragment="contents">
		<div class="container-fluid">
			<div class="d-sm-flex align-items-center justify-content-between mb-4">
				<h1 class="h3 mb-4 text-gray-800">메시지 목록</h1>
			</div>

			<!-- 검색 폼 컨테이너 -->
			<div class="card shadow mb-4">
				<div class="card-body">
					<form class="mb-4" th:action="@{/groupware/message}" method="get">
						<div class="row mb-2">
							<div class="col-md-3">
								<select name="type" class="form-control">
									<option value="">알림 유형 선택</option>
									<option th:each="code : ${messageTypes}" th:value="${code.minorName}" th:text="${code.minorName}"></option>
								</select>
							</div>
							<div class="col-md-3">
								<input type="text" name="senderId" class="form-control" placeholder="발신자 ID 입력">
							</div>
							<div class="col-md-3">
								<input type="text" name="receiverId" class="form-control" placeholder="수신자 ID 입력">
							</div>

							<!-- 버튼들 -->
							<div class="col-12 col-sm-auto mb-2 d-flex justify-content-end">
								<button class="btn btn-success mr-2" id="btnRegister" type="button">메시지 등록</button>
								<button class="btn btn-primary" id="btnSearch" type="submit">검색</button>
							</div>
						</div>

						<div class="row">
							<div class="col-md-6">
								<input type="datetime-local" name="sendDate" class="form-control" th:value="${searchDTO?.sendDate != null} ? ${#temporals.format(searchDTO.sendDate, 'yyyy-MM-dd\'T\'HH:mm')} : ''">
							</div>
							<div class="col-md-6">
								<input type="datetime-local" name="receiveDate" class="form-control" th:value="${searchDTO?.receiveDate != null} ? ${#temporals.format(searchDTO.receiveDate, 'yyyy-MM-dd\'T\'HH:mm')} : ''">
							</div>
						</div>
					</form>
				</div>
			</div>
			<!-- 메시지 목록 테이블 -->
			<div class="card shadow mb-4">
				<div class="card-body">
					<div class="table-responsive">
						<table class="table table-bordered table-hover text-center" id="dataTables" width="100%" cellspacing="0">
							<thead>
								<tr>
									<th>인덱스</th>
									<th>알림 유형</th>
									<th>제목</th>
									<th>발신자</th>
									<th>발신일</th>
									<th>수신자</th>
									<th>읽음여부</th>
								</tr>
							</thead>
							<tbody>
								<tr th:each="message : ${messageDTOList}" th:data-id="${message.idx}" class="message-row">
									<td th:text="${message.idx}"></td>
									<td th:text="${message.type}"></td>
									<td th:text="${message.title}"></td>
									<td th:text="${message.senderId}"></td>
									<td th:text="${message.sendDate}"></td>
									<td th:text="${message.receiverId}"></td>
									<td th:text="${message.status}"></td>
								</tr>
								<tr th:if="${#lists.isEmpty(messageDTOList)}">
									<td colspan="6" class="text-center">조회된 데이터가 없습니다.</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
		<!-- 공통 스크립트 -->
		<script type="text/javascript">
			$(document).ready(function() {
				// init DataTable
				$('#dataTables').DataTable({
					lengthChange : false,
					searching : false,
					paging : false,
					info : false
				}); // end of $('#dataTables').DataTable({

				// 등록 버튼(btnRegister) 클릭 시 이벤트(메시지 등록)
				$('#btnRegister').on("click", function() {
					console.log("btnRegister click!!!");
					location.href = "/groupware/message/new";
				});

				// 메시지 리스트 각 행 클릭 시 (상세 보기 페이지 이동)
				$("#dataTables tbody").on('click', 'tr', function() {
					console.log("dataTables tbody click!!");
					var documentNumber = $(this).data('id');

					if (!documentNumber) {
						return; // 페이지 이동 막기
					}

					// 수정된 부분: idx가 아닌 documentNumber를 사용
					location.href = "/groupware/message/" + documentNumber;
				});
			});
		</script>
		<th:block layout:fragment="contents">
</body>
</html>
