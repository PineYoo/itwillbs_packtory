<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/de_layout}">

<head>
    <title>팩토리(PackTory) - 규정 상세</title>
    
    <th:block layout:fragment="css">
        <link href="/css/sb-admin-2.css" rel="stylesheet">
        <link href="/css/common.css" rel="stylesheet">
    </th:block>
</head>

<body id="page-top">
    <div layout:fragment="contents">
        <div class="container mt-5">
            <h2 class="h3 mb-4 text-gray-800">규정 상세</h2>
            
<!--        <form id="policyForm" th:action="@{/detail/{idx}}" method="post"> -->
            <form id="policyForm" th:action="@{/policy/detail/{idx}(idx=${policyDTO.idx})}" method="post">
                <div class="form-group">
                    <label>규정 유형</label>
                    <select name="type" id="type" class="form-control" disabled>
                    	<option value="">선택하세요</option>
                        <option th:each="code : ${policyTypes}" 
                                th:value="${code.minorName}" 
                                th:text="${code.minorName}"
                                th:selected="${policyDTO.type == code.minorName}">
                        </option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>제목</label>
                    <input type="text" id="title" name="title" class="form-control" th:value="${policyDTO.title}" readonly>
                </div>
                
                <div class="form-group">
                    <label>내용</label>
                    <textarea id="contents" name="contents" class="form-control" rows="5" readonly>[[${policyDTO.contents}]]</textarea>
                </div>

                <div class="form-group">
                    <label>게시 여부</label>
                    <span th:text="${policyDTO.status}" class="form-control-plaintext"></span>
                </div>
                
                <div class="form-group">
                    <label>첨부 파일</label>
                    <ul>
                        <li th:each="fileId : ${policyDTO.fileIdxs}" th:text="'파일 ID: ' + ${fileId}"></li>
                    </ul>
                </div>
                
                <div class="form-group">
                    <label>작성자</label>
                    <span th:text="${policyDTO.regId}" class="form-control-plaintext"></span>
                </div>
                
                <div class="form-group">
                    <label>작성일자</label>
                    <span th:text="${policyDTO.regDate}" class="form-control-plaintext"></span>
                </div>
                
                <div class="form-group">
                    <label>최종 수정자</label>
                    <span th:text="${policyDTO.modId}" class="form-control-plaintext"></span>
                </div>
                
                <div class="form-group">
                    <label>최종 수정일자</label>
                    <span th:text="${policyDTO.modDate}" class="form-control-plaintext"></span>
                </div>
                
                <button type="button" id="editBtn" class="btn btn-warning">수정</button>
                <button type="submit" id="submitBtn" class="btn btn-primary" style="display: none;">저장</button>
                <button type="button" id="deleteBtn" class="btn btn-danger"  th:attr="data-idx=${policyDTO.idx}">삭제</button>
            	<a href="/policy" class="btn btn-secondary" style="float: right;">목록으로 돌아가기</a>
            </form>
        </div>
    </div>
    
    <th:block layout:fragment="script">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script type="text/javascript">
        $(document).ready(function() {
            // 수정 버튼 클릭 시 수정 필드 활성화
            $("#editBtn").on("click", function() {
                try {
                    // 입력 필드 활성화
                    $("input[readonly]").prop("readonly", false);  
                    $("textarea[readonly]").prop("readonly", false);
                    $("select[disabled]").prop("disabled", false);

                    // 읽기 전용 필드는 유지
                    $("#status, #regId, #regDate, #modId, #modDate").prop("readonly", true);

                    // 버튼 전환
                    $(this).hide(); 
                    $("#submitBtn").show();
                } catch (error) {
                    console.error("수정 버튼 클릭 시 오류 발생:", error);
                    alert("수정 버튼 처리 중 오류가 발생했습니다.");
                }
            });

            // 삭제 버튼 클릭 시
            $("#deleteBtn").on("click", function() {
				try {
		        const policyIdx = $(this).attr("data-idx");
		        console.log("삭제할 규정 ID:", policyIdx);
		
		        if (!policyIdx) {
		            console.error("규정 ID가 존재하지 않습니다.");
		            alert("잘못된 규정 ID입니다.");
		            return;
		        }

		        if (confirm("정말 삭제하시겠습니까?")) {
		            $.ajax({
		                url: `/policy/detail/${policyIdx}`,
		                type: "DELETE",
		                success: function(response) {
		                    console.log("삭제 성공 응답:", response);
		                    if (response === "success") {
		                        alert("규정 삭제 성공!");
		                        location.href = "/policy"; // 목록 페이지 이동
		                    } else {
		                        alert("삭제 실패: " + response);
		                    }
		                },
		                error: function(error) {
		                    console.error("삭제 중 오류 발생:", error);
		                    alert("삭제 과정에서 오류가 발생했습니다.");
		                }
		            });
		        }
		    } catch (error) {
		        console.error("삭제 버튼 클릭 시 오류 발생:", error);
		        alert("삭제 버튼 처리 중 오류가 발생했습니다.");
		    }
		});
	});
    </script>
</th:block>
</body>
</html>
