<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>사원 목록</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style type="text/css">
        /* 기존 Bootstrap 스타일과 함께 사용자 정의 스타일 */
        .clickable-row {
            transition: background-color 0.2s ease; /* 부드러운 배경색 전환 효과 */
        }
        .clickable-row:hover {
            background-color: #e0e0e0; /* 마우스 오버 시 밝은 회색 배경 */
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1>사원 목록</h1>
        <div class="mb-4">
            <form th:action="@{/employee}" method="get" th:object="${searchDTO}" class="form-inline justify-content-between">
                <div class="form-group">
                    <select id="searchType" name="type" th:field="*{type}" class="form-control mr-2">
                        <option value="name">이름</option>
                        <option value="dept">부서</option>
                    </select>
                    <input type="text" id="searchValue" name="searchValue" th:field="*{searchValue}" placeholder="검색어 입력" class="form-control mr-2">
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary mr-2">검색</button>
                    <button type="button" id="btnNew" class="btn btn-success">사원 등록</button>
                </div>
            </form>
        </div>
        
        <table class="table table-bordered">
            <thead class="thead-light">
                <tr>
                    <th>인덱스</th>
                    <th>사원번호</th>
                    <th>이름</th>
                    <th>부서</th>
                    <th>하위부서</th>
                    <th>직급</th>
                    <th>입사일</th>
                    <th>경력</th>
                    <th>관리</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="employee : ${employeeList}" th:data-id="${employee.id}" class="clickable-row">
                    <td data-key="idx" th:text="${employee.idx}"></td>
                    <td data-key="id" th:text="${employee.id}"></td>
                    <td data-key="name" th:text="${employee.name}" class="editable"></td>
                    <td data-key="departmentCode" th:text="${employee.departmentCode}" class="editable"></td>
                    <td data-key="subDepartmentCode" th:text="${employee.subDepartmentCode}" class="editable"></td>
                    <td data-key="positionCode" th:text="${employee.positionCode}" class="editable"></td>
                    <td data-key="hireDate" th:text="${#temporals.format(employee.hireDate, 'yyyy-MM-dd HH:mm:ss')}"></td>
                    <td data-key="workExperience" th:text="${employee.workExperience != null ? employee.workExperience : '경력 없음'}" class="editable"></td>
                    <td>
                        <button class="btn btn-warning btn-sm edit-btn">수정</button>
                        <button class="btn btn-success btn-sm save-btn" style="display: none;">저장</button>
                        <button class="btn btn-danger btn-sm delete-btn">삭제</button>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="text/javascript">
    $(function() {
        let isEditing = false; // 수정 중 여부 확인

        // 수정 버튼 클릭
        $(".edit-btn").on("click", function() {
            const row = $(this).closest("tr");
            row.find("td.editable").each(function() {
                let text = $(this).text().trim();
                let key = $(this).data("key"); // data-key 속성값 가져오기
                $(this).html(`<input type='text' class='form-control' name='${key}' value='${text}'>`);
            });

            row.addClass("edit-mode");
            $(this).hide();
            row.find(".save-btn").show();
            isEditing = true; // 수정 모드 활성화

            // 수정 중에는 상세 페이지 이동 비활성화
            $(".clickable-row").off("click");
        });

        // 저장 버튼 클릭
        $(".save-btn").on("click", function(event) {
            event.preventDefault(); // 자동 페이지 이동 방지

            const row = $(this).closest("tr");
            const id = row.data("id"); // 사원번호로 id 가져오기
            let updatedData = {};

            // 각 editable td에서 name과 input 값을 가져와 JSON 객체 생성
            row.find("td.editable").each(function() {
                let key = $(this).data("key");
                let value = $(this).find("input").val().trim();
                updatedData[key] = value;
            });
            // id는 따로 설정
            updatedData["id"] = id;

            $.ajax({
                url: `/employee/update/${id}`,
                type: "PUT",  // HTTP 메소드를 PUT으로 변경 (컨트롤러와 일치)
                contentType: "application/json",
                data: JSON.stringify(updatedData),
                success: function() {
                    alert("수정되었습니다.");
                    location.reload();
                },
                error: function() {
                    alert("수정 실패.");
                }
            });

            isEditing = false; // 수정 완료
        });

        // 삭제 버튼 클릭
        $(".delete-btn").on("click", function() {
            const row = $(this).closest("tr");
            const id = row.data("id");

            if (confirm("정말 삭제하시겠습니까?")) {
                $.ajax({
                    url: `/employee/delete/${id}`,
                    type: "DELETE",
                    success: function() {
                        alert("삭제되었습니다.");
                        window.location.href = "/employee"; // 리스트 페이지로 이동
                    },
                    error: function() {
                        alert("삭제 실패.");
                    }
                });
            }
        });

        // 상세 페이지 이동
        $(".clickable-row td:not(.edit-mode)").on("click", function() {
            if (!isEditing) { // 수정 중이 아닐 때만 이동
                const id = $(this).closest("tr").data("id");
                location.href = `/employee/detail/${id}`;
            }
        });

        // 등록 버튼 클릭 시 form 페이지로 이동
        $("#btnNew").on("click", function() {
            location.href = "/employee/new";
        });
    });
    </script>
</body>
</html>
