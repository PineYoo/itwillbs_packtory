<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{common/layouts/de_layout}">
<head>
<title>팩토리(PackTory) - 출퇴근관리</title>
<!-- 부트스트랩 icons 가져오기 -->
<th:block layout:fragment="headContents">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
</th:block>
<!-- CSS -->
<th:block layout:fragment="css">
	<!-- dataTables 가져오기 -->
	<link href="/css/datatables/dataTables.bootstrap4.min.css" rel="stylesheet">
	<link href="/css/datatables/datatables.min.css" rel="stylesheet">
	<link href="/css/datepicker/daterangepicker.css" rel="stylesheet">
	<!-- 폰트어썸 가져오기 -->
	<link href="/css/fontawesome/all.min.css" rel="stylesheet">
	<script src="/css/fontawesome/all.min.js"></script>
	<!-- CSS for Page -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&family=Nunito:wght@200..1000&display=swap" rel="stylesheet">
	<link href="/css/sb-admin-2.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.7.1/css/buttons.dataTables.min.css">
	<!-- 개별 CSS-->
	<link href="/css/common.css" rel="stylesheet">
</th:block>
<style type="text/css">
.commute-container {
	display: flex;
	align-items: center;
}
.commute-container input {
       border: 1px solid #ccc;
       padding: 5px;
       margin: 2px;
       border-radius: 3px;
}
.commute-container button {
	padding: 7px 25px;
}
</style>

</head>
<body id="page-top">
	<div layout:fragment="contents">
		<!-- Begin Page Content -->
		<div class="container-fluid">
			<!-- Page Heading -->
			<div class="d-sm-flex align-items-center justify-content-between mb-4">
				<h1 class="h3 mb-2 text-gray-800">출퇴근 기록 버튼(임시페이지)</h1>
				<p>(메인페이지에 들어 갈 버튼 만드는 중..)</p>
			</div>
			
			<!-- ---------- 본문 컨테이너 ---------- -->
			<div class="card shadow mb-4">
				<div class="card-body">
					<!-- 숨겨진 input으로 데이터 전달 -->
					<input type="hidden" id="modelCheckInTime" th:value="${checkInTime}">
					<input type="hidden" id="modelCheckOutTime" th:value="${checkOutTime}">
					<input type="hidden" id="modelLastStatus" th:value="${lastCommuteRecord != null ? lastCommuteRecord.workStatusCode : ''}">
					
					<div class="commute-container">
						<div>
							출근시간 : <input type="text" id="checkInTime" class="mb-2" disabled><br>
							퇴근시간 : <input type="text" id="checkOutTime" class="mb-2" disabled>
						</div>
						
						<div style="margin-left: 5px;">
							<th:block th:each="i : ${#numbers.sequence(0, codeItemList.size() - 1, 2)}">
						        <div class="d-flex flex-wrap mb-2">
						            <th:block th:if="${i < codeItemList.size()}" th:with="item=${codeItemList[i]}">
						                <button th:id="${item.minorName}"
						                        class="btn btn-primary mr-2 work-btn"
						                        th:data-code="${item.minorCode}"
						                        th:data-name="${item.minorName}"
						                        th:text="${item.minorName}">
						                </button>
						            </th:block>
						            <th:block th:if="${i + 1 < codeItemList.size()}" th:with="item=${codeItemList[i + 1]}">
						                <button th:id="${item.minorName}"
						                        class="btn btn-primary mr-2 work-btn"
						                        th:data-code="${item.minorCode}"
						                        th:data-name="${item.minorName}"
						                        th:text="${item.minorName}">
						                </button>
						            </th:block>
						        </div>
						    </th:block>
						</div>
						
					</div>
				</div>
			</div>
			<!-- ---------- 본문 컨테이너 끝 ---------- -->
		</div>
		
		<script type="text/javascript">
			$(document).ready(function () {
			    // 초기 버튼 상태 설정
			    const checkInBtn = $("#출근");
			    const checkOutBtn = $("#퇴근");
			    const outSideBtn = $("#외근");
			    const comeBackBtn = $("#복귀");
	
			    const modelCheckInTime = $('#modelCheckInTime').val();		// 출근 시간
			    const modelCheckOutTime = $('#modelCheckOutTime').val();	// 퇴근 시간
			    const modelLastStatus = $('#modelLastStatus').val();   		// 마지막 근무 상태 코드
	
			    // 초기 시간 세팅
			    if (modelCheckInTime) {	// 출근시간
			        $('#checkInTime').val(modelCheckInTime);
			    }
			    if (modelCheckOutTime) {	// 퇴근시간
			        $('#checkOutTime').val(modelCheckOutTime);
			    }
	
			    // workStatusCode를 기반으로 minorName 찾기
			    let lastStatusName = null;
			    if (modelLastStatus) {
			        const statusItem = codeItemList.find(item => item.minorCode == modelLastStatus);
			        if (statusItem) {
			            lastStatusName = statusItem.minorName;
			        }
			    }
	
			    // 버튼 초기 상태 설정
			    function initButtonState(statusName) {
			        checkInBtn.prop("disabled", true);
			        checkOutBtn.prop("disabled", true);
			        outSideBtn.prop("disabled", true);
			        comeBackBtn.prop("disabled", true);
	
			     	// 출근 전
			        if (!statusName) {
			            checkInBtn.prop("disabled", false);
			            return;
			        }

		            const now = new Date();
		            const today = now.toISOString().slice(0, 10); // 오늘 날짜
		            
			        // 출근은 했고 퇴근 전이면 (상태가 출근/외근/복귀 관계없이)
			        if (modelCheckInTime && !modelCheckOutTime) {
			            const checkIn = new Date(`${today}T${modelCheckInTime}`);
// 		                const checkOutTime = new Date(checkIn.getTime() + 9 * 60 * 60 * 1000);	// 9시간
			            const checkOutTime = new Date(checkIn.getTime() + 10 * 1000);	// 테스트용 (10초 후 퇴근 가능)
		                const delay = checkOutTime - now;	// 퇴근까지 남은시간

			            if (now >= checkOutTime) {	// 퇴근시간이 되었을 경우
			                checkOutBtn.prop("disabled", false);	// 퇴근 O
			            } else {	// 아직 퇴근시간 아닐 경우
			                setTimeout(() => {
				                checkOutBtn.prop("disabled", false);	// 퇴근 O
			                }, delay);
			            }
		                
			            // 외근: 퇴근 시간 도달 전, 퇴근 기록 없고, 상태가 출근 또는 복귀일 때만 가능
			            if (now < checkOutTime && !modelCheckOutTime && (statusName === '출근' || statusName === '복귀')) {
			                outSideBtn.prop("disabled", false);	// 외근 O
			            }
			        }

			        // 현재 상태에 따라 외근/복귀 버튼 설정
			        switch (statusName) {
			            case '출근':
			            case '복귀':
			            	// 위에서 외근 버튼 처리하므로 이 블럭은 생략 가능
			                break;
			            case '외근':
			                comeBackBtn.prop("disabled", false);
			                break;
			            case '퇴근':
			                // 모든 버튼 비활성화
			                break;
			        }
			    }
	
			    initButtonState(lastStatusName);
	
			    // 출퇴근시간 포맷 함수
			    function formatTime(date) {
			        const hh = String(date.getHours()).padStart(2, '0');
			        const mm = String(date.getMinutes()).padStart(2, '0');
			        const ss = String(date.getSeconds()).padStart(2, '0');
			        return `${hh}:${mm}:${ss}`;
			    }
			    
			    // 버튼 클릭 이벤트
			    $('.work-btn').on('click', function () {
			        const $btn = $(this);
			        const workStatusCode = $btn.data('code');
			        const workStatusName = $btn.data('name');
	
			        const now = new Date();
			        if (workStatusName === '출근') {
			            $('#checkInTime').val(formatTime(now));
			        } else if (workStatusName === '퇴근') {
			            $('#checkOutTime').val(formatTime(now));
			        }
	
			        // 버튼 상태 변경
			        switch (workStatusName) {
			            case '출근':
			                checkInBtn.prop("disabled", true);
			                outSideBtn.prop("disabled", false);
	
			             	// 테스트용: 10초 뒤 퇴근 버튼 활성화
			                const futureTime = new Date(now.getTime() + 10 * 1000);	// 9시간 : 9 * 60 * 60 * 1000
			                const delay = futureTime.getTime() - now.getTime();

			                setTimeout(() => {
			                    checkOutBtn.prop("disabled", false);	// 출근 O
			                    outSideBtn.prop("disabled", true);		// 외근 X
			                }, delay);
			                break;
	
			            case '외근':
			                outSideBtn.prop("disabled", true);
			                comeBackBtn.prop("disabled", false);
			                break;
	
			            case '복귀':
			                comeBackBtn.prop("disabled", true);
			             	
			                // 복귀 로직 - 출근 시간 기준으로 퇴근 시간 비교
			                const checkInTime = $('#checkInTime').val();
			                if (checkInTime) {
			                    const today = now.toISOString().slice(0, 10);  // YYYY-MM-DD
			                    const checkInDate = new Date(`${today}T${checkInTime}`); // 출근 시각
			                    const futureTimeForComeback = new Date(checkInDate.getTime() + 10 * 1000); // 출근 10초 후가 퇴근 시간 기준
			                    const nowForComeback = new Date();

			                    if (nowForComeback < futureTimeForComeback) {   // 퇴근시간 전
			                        outSideBtn.prop("disabled", false); // 외근 O
			                    } else {    // 퇴근시간 이후
			                        outSideBtn.prop("disabled", true);  // 외근 X
			                    }
			                }
			                break;
	
			            case '퇴근':
			                checkOutBtn.prop("disabled", true);
			                outSideBtn.prop("disabled", true);
			                comeBackBtn.prop("disabled", true);
			                break;
			        }
	
			        // AJAX 전송
			        $.ajax({
			            url: '/commute/save',
			            type: 'POST',
			            contentType: 'application/json',
			            data: JSON.stringify({
			                workStatusCode: workStatusCode
			            }),
			            success: function (response) {
			                alert('처리 완료: ' + workStatusName);
			                console.log(response);
			            },
			            error: function (xhr, status, error) {
			                alert('전송 실패');
			                console.error(error);
			            }
			        });
			    });
			});
		</script>
		
		
		
	</div>
	<th:block layout:fragment="script">
		<!-- Bootstrap core JavaScript-->
		<script src="/js/bootstrap/js/bootstrap.bundle.min.js"></script>
		<script src="/js/jquery-3.7.1.js"></script>
	    <!-- Core plugin JavaScript-->
	    <script src="/js/jquery-easing/jquery.easing.min.js"></script>
	    <!-- Custom scripts for all pages-->
	    <script src="/js/sb-admin-2.min.js"></script>
	   	<!-- Page level plugins -->
		<script src="/js/datatables/jquery.dataTables.min.js"></script>
		<script src="/js/datatables/dataTables.bootstrap4.min.js"></script>
		<script src="/js/demo/datatables-demo.js"></script>
	   	<script src="/js/datepicker/moment.min.js"></script>
	   	<script src="/js/datepicker/daterangepicker.js"></script>
	   	<script src="/js/datatables/dataTables.buttons.min.js"></script>
		<script src="/js/datatables/buttons.html5.min.js"></script>
		<script src="/js/datatables/jszip.min.js"></script>
		<script src="/js/datatables/buttons.print.min.js"></script>
		
		<!-- codeItemList를 JSON 문자열로 넘기기 -->
		<script th:inline="javascript">
			let codeItemList = /*[[${codeItemList}]]*/ null;
		</script>
	</th:block>

</body>

</html>