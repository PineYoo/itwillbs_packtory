<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/de_layout}">
<head>
    <title>팩토리(PackTory) - 사원 목록</title>

    <th:block layout:fragment="headContents">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    </th:block>

    <th:block layout:fragment="css">
        <link href="/css/datatables/dataTables.bootstrap4.min.css" rel="stylesheet">
        <link href="/css/datatables/datatables.min.css" rel="stylesheet">
        <link href="/css/fontawesome/all.min.css" rel="stylesheet">
        <script src="/css/fontawesome/all.min.js"></script>
        <link href="/css/sb-admin-2.css" rel="stylesheet">
        <link href="/css/common.css" rel="stylesheet">
    </th:block>

    <style>
        .table tbody tr.clickable-row:hover {
            background-color: #e0e0e0 !important;
            cursor: pointer;
        }
    </style>
</head>
<body id="page-top">
<div layout:fragment="contents" class="container">

    <h1 class="h3 mb-4 text-gray-800">사원 목록</h1>

    <!-- 검색 폼 -->
    <form method="get" th:action="@{/human/employee}">
	    <div class="row align-items-center mb-3">
			<div class="col-md-2">
			    <input type="text" name="name" class="form-control" placeholder="이름 검색"
			           th:value="${param.name}">
			</div>
	        <div class="col-md-2">
	            <select id="departmentCode" name="departmentCode" class="form-control">
	                <option value="">대표부서 선택</option>
	                <option th:each="department : ${validDepartments}"
					        th:value="${department.minorCode}"
					        th:text="${department.minorName}"
					        th:selected="${searchDTO != null and searchDTO.departmentCode == department.minorCode}">
					</option>
	            </select>
	        </div>
	        <div class="col-md-2">
	            <select id="subDepartmentCode" name="subDepartmentCode" class="form-control">
	                <option value="">하위부서 선택</option>
	            </select>
	        </div>
	        <div class="col-md-2">
	            <select name="positionCode" class="form-control">
	                <option value="">직급 선택</option>
	                <option th:each="position : ${validPositions}"
					        th:value="${position.idx}"
					        th:text="${position.positionCode}"
					        th:selected="${searchDTO != null and searchDTO.positionCode == position.idx}">
					</option>
	            </select>
	        </div>
	        <div class="col-md-2">
	            <button type="submit" class="btn btn-primary w-100">검색</button>
	        </div>
	
	        <!-- 등록 버튼: 오른쪽 정렬 -->
	        <div class="col-md-2 text-end">
	            <button type="button" id="btnNew" class="btn btn-success">사원 등록</button>
	        </div>
	    </div>
	</form>

    <!-- 목록 테이블 -->
    <div class="table-responsive">
        <table class="table table-bordered mx-auto" id="dataTable" style="width: 100%; max-width: 1200px;">
            <thead class="thead-light">
            <tr>
                <th>인덱스</th>
                <th>사원번호</th>
                <th>이름</th>
                <th>대표부서</th>
                <th>하위부서</th>
                <th>직급</th>
                <th>입사일</th>
                <th>경력</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="employee : ${employeeList}"
                th:data-id="${employee.id}"
                th:data-idx="${employee.idx}"
                class="clickable-row">
                <td th:text="${employee.idx}"></td>
                <td th:text="${employee.id}"></td>
                <td th:text="${employee.name}"></td>
                <td th:text="${employee.departmentCode}"></td>
                <td th:text="${employee.subDepartmentCode}"></td>
                <td th:text="${employee.positionCode}"></td>
                <td th:text="${#temporals.format(employee.hireDate, 'yyyy-MM-dd')}"></td>
                <td th:text="${employee.workExperience}"></td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- 스크립트 영역 -->
<th:block layout:fragment="script">
    <script src="/js/jquery-3.7.1.js"></script>
    <script src="/js/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="/js/datatables/jquery.dataTables.min.js"></script>
    <script src="/js/datatables/dataTables.bootstrap4.min.js"></script>
    <script>
        $(function () {
            // 데이터테이블
            $('#dataTable').DataTable({
                paging: true,
                searching: false,
                info: true,
                lengthChange: true,
                language: {
                    url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/Korean.json"
                }
            });

            let isEditing = false;

            // 행 클릭 시 상세 페이지 이동
            $(document).on("click", ".clickable-row", function (event) {
                if (!isEditing && !$(event.target).closest('button').length) {
                    const id = $(this).data("id");
                    location.href = `/human/employee/${id}`;
                }
            });

            // 등록 페이지 이동
            $("#btnNew").on("click", function () {
                location.href = "/human/employee/new";
            });

            // 하위 부서 로딩
            $('#departmentCode').on("change", function () {
                const selectedCode = $(this).val();
                if (!selectedCode) {
                    $('#subDepartmentCode').empty().append('<option value="">하위 부서를 선택하세요</option>');
                    return;
                }

                $.ajax({
                    url: '/human/employee/subDepartments',
                    type: 'GET',
                    data: {departmentCode: selectedCode},
                    success: function (data) {
                        let html = '<option value="">하위 부서를 선택하세요</option>';
                        data.forEach(function (item) {
                            html += `<option value="${item.childCode}">${item.childName}</option>`;
                        });
                        $('#subDepartmentCode').html(html);
                    },
                    error: function () {
                        alert("하위 부서 정보를 불러오는 데 실패했습니다.");
                    }
                });
            });
            
         	// 검색 후에도 하위 부서 복원
            const selectedDepartmentCode = $('#departmentCode').val();
            const selectedSubDepartmentCode = new URLSearchParams(window.location.search).get('subDepartmentCode');

            if (selectedDepartmentCode) {
                loadSubDepartments(selectedDepartmentCode, selectedSubDepartmentCode);
            }

            // 부서 변경 시 하위 부서 로딩
            $('#departmentCode').on("change", function () {
                const selectedCode = $(this).val();
                loadSubDepartments(selectedCode);
            });
        });
    </script>
</th:block>
</body>
</html>
